# coding: utf-8

"""
    Idempotency key generation unit tests for vpcloud_client.

    Generated by OpenAPI Generator (https://openapi-generator.tech)
    Do not edit the class manually.
"""  # noqa: E501

import pytest
import uuid
from unittest.mock import Mock, patch
from vpcloud_client import Configuration, ApiClient
from vpcloud_client.api.node_operations_api import NodeOperationsApi


class TestIdempotencyKeys:
    """Idempotency key generation tests"""

    def test_auto_generate_idempotency_key_post(self):
        """Test idempotency key auto-generated for POST."""
        config = Configuration(auto_idempotency_key=True)
        api = NodeOperationsApi(api_client=ApiClient(config))
        
        # Call actual serialize method to test idempotency key injection
        from uuid import UUID
        result = api._remediate_nodes_serialize(
            fleet_id=UUID('12345678-1234-1234-1234-123456789abc'),
            remediate_node_request=[],
            idempotency_key=None,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        header_params = result[2]
            
        # Verify Idempotency-Key was added
        assert 'Idempotency-Key' in header_params
        # Verify it's a valid UUID
        uuid.UUID(header_params['Idempotency-Key'])

    def test_no_idempotency_key_get(self):
        """Test idempotency key NOT generated for GET."""
        config = Configuration(auto_idempotency_key=True)
        from vpcloud_client.api.fleets_api import FleetsApi
        api = FleetsApi(api_client=ApiClient(config))
        
        # Call actual serialize method for GET request
        result = api._list_fleets_serialize(
            limit=None,
            next_token=None,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        header_params = result[2]
            
        # Verify Idempotency-Key is NOT in headers for GET
        assert 'Idempotency-Key' not in header_params

    def test_auto_idempotency_key_disabled(self):
        """Test idempotency key is NOT generated when disabled."""
        config = Configuration(auto_idempotency_key=False)
        api = NodeOperationsApi(api_client=ApiClient(config))
        
        from uuid import UUID
        result = api._remediate_nodes_serialize(
            fleet_id=UUID('12345678-1234-1234-1234-123456789abc'),
            remediate_node_request=[],
            idempotency_key=None,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        header_params = result[2]
            
        # Verify Idempotency-Key is NOT in headers when disabled
        assert 'Idempotency-Key' not in header_params

    def test_preserves_existing_idempotency_key(self):
        """Test that provided idempotency key is not overwritten."""
        config = Configuration(auto_idempotency_key=True)
        api = NodeOperationsApi(api_client=ApiClient(config))
        
        custom_key = "custom-key-12345"
        
        from uuid import UUID
        result = api._remediate_nodes_serialize(
            fleet_id=UUID('12345678-1234-1234-1234-123456789abc'),
            remediate_node_request=[],
            idempotency_key=custom_key,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        header_params = result[2]
            
        # Verify the custom key is preserved
        assert header_params['Idempotency-Key'] == custom_key

    def test_custom_idempotency_key_generator(self):
        """Test custom idempotency key generator function."""
        def custom_generator():
            return "custom-generated-key"
        
        config = Configuration(
            auto_idempotency_key=True,
            idempotency_key_generator=custom_generator
        )
        api = NodeOperationsApi(api_client=ApiClient(config))
        
        from uuid import UUID
        result = api._remediate_nodes_serialize(
            fleet_id=UUID('12345678-1234-1234-1234-123456789abc'),
            remediate_node_request=[],
            idempotency_key=None,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        header_params = result[2]
            
        # Verify custom generator was used
        assert header_params['Idempotency-Key'] == "custom-generated-key"

    def test_idempotency_key_post_only(self):
        """Test idempotency key generated for POST operations."""
        config = Configuration(auto_idempotency_key=True)
        api = NodeOperationsApi(api_client=ApiClient(config))
        
        # Test POST
        from uuid import UUID
        result = api._remediate_nodes_serialize(
            fleet_id=UUID('12345678-1234-1234-1234-123456789abc'),
            remediate_node_request=[],
            idempotency_key=None,
            _request_auth=None,
            _content_type=None,
            _headers=None,
            _host_index=0
        )
        # RequestSerialized is a tuple: (method, url, header_params, body, files)
        assert 'Idempotency-Key' in result[2]

